@inject IJSRuntime JsRuntime
@using ZipTabel.Model

<div style="border: 1px solid black; padding: 5px; width: 100px; height: 30px;">
    @if (IsFormula)
    {
        <span style="color: blue;">@Cell.Formula</span>
    }
    else
    {
        @foreach (var (charValue, index) in Cell.Value?.Select((c, i) => (c, i)) ?? Enumerable.Empty<(char, int)>())
        {
            <span style="color: @(Cell.GetCharColor(index)); font-size: @(Cell.GetCharSize(index))px;">
                @charValue
            </span>
        }
    }
</div>

<input @oninput="HandleInputChange" @ondblclick="OnCellDoubleClick" style="margin-top: 10px; width: 100px;" placeholder="Enter value" id="userInput" />

@code {
    [Parameter] public Cell Cell { get; set; }

    private string UserInput ;
    private bool IsEditing = false;  
    private bool IsFormula => !string.IsNullOrEmpty(UserInput) && UserInput.StartsWith("=");

    protected override async Task OnInitializedAsync()
    {
        UserInput = Cell.Value;
    }
 

    private async void OnCellDoubleClick()
    {
        IsEditing = true;
        

        if (String.IsNullOrEmpty(Cell.Value))
        {
            Cell.Value = "=";
        }
        UserInput = Cell.Value;
    }

    private void HandleInputChange(ChangeEventArgs e)
    {
        UserInput = e.Value.ToString();
        if (IsFormula)
        {
            Cell.Formula = UserInput;
            Cell.Recalculate();
        }
        else
        {
            Cell.Value = UserInput;
        }

        IsEditing = false;  
    }

    private string EditingClass => IsEditing ? "editing" : string.Empty;
}
